@inherits Dynamicweb.Rendering.RazorTemplateBase<Dynamicweb.Rendering.RazorTemplateModel<Dynamicweb.Rendering.Template>>

@using System.Text;
@using System.Security.Cryptography;

@functions {
	/// Hashes an email with MD5.  Suitable for use with Gravatar profile
	/// image urls
	public static string HashEmailForGravatar(string email)
	{
		// Create a new instance of the MD5CryptoServiceProvider object.
		MD5 md5Hasher = MD5.Create();

		// Convert the input string to a byte array and compute the hash.
		byte[] data = md5Hasher.ComputeHash(Encoding.Default.GetBytes(email));

		// Create a new Stringbuilder to collect the bytes
		// and create a string.
		StringBuilder sBuilder = new StringBuilder();

		// Loop through each byte of the hashed data
		// and format each one as a hexadecimal string.
		for (int i = 0; i < data.Length; i++)
		{
			sBuilder.Append(data[i].ToString("x2"));
		}

		return sBuilder.ToString();  // Return the hexadecimal string.
	}
}

@helper Gravatar(int size = 0)
{
	var hash = HashEmailForGravatar(GetString("Item.Email"));
	if (size == 0)
	{
		size = 32;
	}
	<img class="gravatar" src='http://www.gravatar.com/avatar/@hash?size=@size' width="@size" height="@size" />
}

<article class="guestbook-entry">
	<header>
		@Gravatar() <span class="name">@GetValue("Item.Name")</span><span class="time">@GetDate("Item.Time").ToString("yyyy-MM-hh HH:mm")</span>
	</header>

	<div class="message">
		@GetValue("Item.Text")
	</div>
</article>
